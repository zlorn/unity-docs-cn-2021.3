<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="Managed memory - Unity 手册">
<title>Managed memory - Unity 手册</title>
<meta property="og:image" content="https://docs.unity3d.com/cn/2021.3/uploads/Main/managed-heap.jpg">
<meta name="description" content="Unity’s managed memory system is a C# scripting environment based on the Mono or IL2CPP Virtual Machines (VMs). The benefit of the managed memory system is that it manages the release of memory, so you don’t need to manually request the release of memory through your code.">
<meta property="og:description" content="Unity’s managed memory system is a C# scripting environment based on the Mono or IL2CPP Virtual Machines (VMs). The benefit of the managed memory system is that it manages the release of memory, so you don’t need to manually request the release of memory through your code.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836"></script><script type="text/javascript">
        function OptanonWrapper() { }
    </script><script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'performance-managed-memory';
      if(!page) page = 'index';
      var version = '2021.3';
      var docs_versions = [{version: '2022.1',version_string: '2022.1',supported: true},{version: '2021.3',version_string: '2021.3',supported: true},{version: '2021.2',version_string: '2021.2',supported: false},{version: '2021.1',version_string: '2021.1',supported: false},{version: '2020.3',version_string: '2020.3',supported: true},{version: '2020.2',version_string: '2020.2',supported: false},{version: '2020.1',version_string: '2020.1',supported: false},{version: '2019.4',version_string: '2019.4',supported: true},{version: '2019.3',version_string: '2019.3',supported: false},{version: '2019.2',version_string: '2019.2',supported: false},{version: '2019.1',version_string: '2019.1',supported: false},{version: '2018.4',version_string: '2018.4',supported: false},{version: '2018.3',version_string: '2018.3',supported: false},{version: '2018.2',version_string: '2018.2',supported: false},{version: '2018.1',version_string: '2018.1',supported: false},{version: '2017.4',version_string: '2017.4',supported: false},{version: '2017.3',version_string: '2017.3',supported: false},{version: '2017.2',version_string: '2017.2',supported: false},{version: '2017.1',version_string: '2017.1',supported: false},{version: '5.6',version_string: '560',supported: false},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/2021.3/Manual/performance-managed-memory.html">
<link rel="alternate" href="https://docs.unity3d.com/en/2021.3/Manual/performance-managed-memory.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/cn/2021.3/Manual/performance-managed-memory.html" hreflang="zh">
<link rel="alternate" href="https://docs.unity3d.com/ja/2021.3/Manual/performance-managed-memory.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/2021.3/Manual/performance-managed-memory.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/2021.3/Manual/performance-managed-memory.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/2021.3/Manual/performance-managed-memory.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/2021.3/Documentation/Manual/performance-managed-memory.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="./index.html"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/performance-managed-memory.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/performance-managed-memory.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/performance-managed-memory.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/performance-managed-memory.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/performance-managed-memory.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/performance-managed-memory.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/performance-managed-memory.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/performance-managed-memory.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/performance-managed-memory.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/performance-managed-memory.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/performance-managed-memory.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/performance-managed-memory.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/performance-managed-memory.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/performance-managed-memory.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/performance-managed-memory.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/performance-managed-memory.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/performance-managed-memory.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/performance-managed-memory.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/performance-managed-memory.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/performance-managed-memory.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2021.3/Documentation/Manual/performance-managed-memory.html">English</a></li>
<li><a data-lang="cn" href="/cn/2021.3/Manual/performance-managed-memory.html">中文</a></li>
<li><a data-lang="ja" href="/ja/2021.3/Manual/performance-managed-memory.html">日本語</a></li>
<li><a data-lang="es" href="/es/2021.3/Manual/performance-managed-memory.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2021.3/Manual/performance-managed-memory.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/2021.3/Manual/performance-managed-memory.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/performance-managed-memory.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/performance-managed-memory.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/performance-managed-memory.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/performance-managed-memory.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/performance-managed-memory.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/performance-managed-memory.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/performance-managed-memory.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/performance-managed-memory.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/performance-managed-memory.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/performance-managed-memory.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/performance-managed-memory.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/performance-managed-memory.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/performance-managed-memory.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/performance-managed-memory.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/performance-managed-memory.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/performance-managed-memory.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/performance-managed-memory.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/performance-managed-memory.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/performance-managed-memory.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/performance-managed-memory.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual 2021.3 (LTS)</a></li>
<li><a href="UnityOverview.html">在 Unity 中操作</a></li>
<li><a href="analysis.html">分析</a></li>
<li><a href="performance-memory-overview.html">Memory in Unity</a></li>
<li>Managed memory</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="performance-memory-overview.html"></a></span><div class="tip">Memory in Unity</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="memory-allocator-customization.html"></a></span><div class="tip">Memory allocator customization</div>
</div>
</div></div>
<h1>Managed memory</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>Unity’s <strong>managed memory system</strong> is a C# scripting environment based on the <a href="scripting-backends.html">Mono or IL2CPP Virtual Machines (VMs)</a>. The benefit of the managed memory system is that it manages the release of memory, so you don’t need to manually request the release of memory through your code. </p>

<p>Unity’s managed memory system uses a <a href="performance-garbage-collector.html">garbage collector</a> and a <a href="#managed-heap">managed heap</a> to automatically free memory allocations when your scripts no longer hold any references to those allocations. This helps safeguard against memory leaks. Memory leaks occur when memory is allocated, the reference to it is lost, and then the memory is never freed because it needs a <a href="#value-reference">reference</a> to it to free it. </p>

<p>This memory management system also guards memory access, which means that you can’t access memory that has been freed, or that was never valid for your code to access. However, this memory management process impacts runtime performance, because allocating managed memory is time-consuming for the CPU. <a href="performance-garbage-collector.html">Garbage collection</a> might also stop the CPU from doing other work until it completes.</p>

<p><a name="value-reference"></a></p>

<h2>Value and reference types</h2>

<p>When a method is called, the scripting back end copies the values of its parameters to an area of memory reserved for that specific call, in a data structure called a <strong>call stack</strong>. The scripting back end can quickly copy data types that occupy a few bytes. However, it’s common for objects, strings, and arrays to be much larger, and it’s inefficient for the scripting back end to copy these types of data on a regular basis.</p>

<p>All non-null <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/reference-types">reference-type objects</a> and all <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/types/boxing-and-unboxing">boxed value-typed objects</a> in managed code must be allocated on the managed heap.</p>

<p>It’s important that you are familiar with value and reference types, so that you can effectively manage your code. For more information, see Microsoft’s documentation on <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/value-types">value types</a>, and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/reference-types">reference types</a>.</p>

<h2>Automatic memory management</h2>

<p>When an object is created, Unity allocates the memory required to store it from a central pool called <strong>the heap</strong>, which is a section of memory that your Unity project’s selected scripting runtime (Mono or IL2CPP) automatically manages. When an object is no longer in use, the memory it once occupied can be reclaimed and used for something else. </p>

<p><a href="scripting-backends.html">Unity’s scripting back ends</a> use a <a href="performance-garbage-collector.html">garbage collector</a> to automatically manage your application’s memory, so that you don’t need to allocate and release these blocks of memory with explicit method calls. Automatic memory management requires less coding effort than explicit allocation/release and reduces the potential for memory leaks.</p>

<p><a name="managed-heap"></a></p>

<h3>Managed heap overview</h3>

<p>The <strong>managed heap</strong> is a section of memory that your Unity project’s selected scripting runtime (Mono or IL2CPP) automatically manages. </p>

<figure>
<img src="../uploads/Main/managed-heap.jpg" alt="A quantity of memory. Marked A on the diagram is some free memory.">
<figcaption>A quantity of memory. Marked A on the diagram is some free memory.</figcaption>
</figure>

<p>In the above diagram, the blue box represents a quantity of memory that Unity allocates to the managed heap. The white boxes within it represent data values that Unity stores within the managed heap’s memory space. When additional data values are needed, Unity allocates them free space from the managed heap (annotated <strong>A</strong>).</p>

<h3>Memory fragmentation and heap expansion</h3>

<figure>
<img src="../uploads/Main/managed-heap-removed-objects.jpg" alt="A quantity of memory, with some objects released represented by grey dashed lines.">
<figcaption>A quantity of memory, with some objects released represented by grey dashed lines.</figcaption>
</figure>

<p>The above diagram shows an example of memory fragmentation. When Unity releases an object, the memory that the object occupied is freed up. However, the free space doesn’t become part of a single large pool of “free memory.” </p>

<p>The objects on either side of the released object might still be in use. Because of this, the freed space is a “gap” between other segments of memory. Unity can only use this gap to store data of identical or lesser size than the released object.</p>

<p>This situation is called <strong>memory fragmentation</strong>. This happens when there is a large amount of memory available in the heap, but it is only available in the “gaps” between objects. This means that even though there is enough total space for a large memory allocation, the managed heap can’t find a large enough single block of contiguous memory to assign to the allocation.</p>

<figure>
<img src="../uploads/Main/managed-heap-fragmentation.jpg" alt="The object annotated A, is the new object needed to be added to the heap. The items annotated B are the memory space that the released objects took up, plus the free, unreserved memory. Even though there is enough total free space, because there isnt enough contiguous space, the memory for the new object annotated A cant fit on the heap, and the garbage collector must run.">
<figcaption>The object annotated A, is the new object needed to be added to the heap. The items annotated B are the memory space that the released objects took up, plus the free, unreserved memory. Even though there is enough total free space, because there isn’t enough contiguous space, the memory for the new object annotated A can’t fit on the heap, and the garbage collector must run.</figcaption>
</figure>

<p>If a large object is allocated and there is insufficient contiguous free space to accommodate it, as illustrated above, the Unity memory manager performs two operations:</p>

<ul>
<li>First, the garbage collector runs, if it hasn’t already done so. This attempts to free up enough space to fulfill the allocation request.</li>
<li>If, after the garbage collector runs, there is still not enough contiguous space to fit the requested amount of memory, the heap must expand. The specific amount that the heap expands is platform-dependent; however, on most platforms, when the heap expands, it expands by double the amount of the previous expansion.</li>
</ul>

<h3>Managed heap expansion considerations</h3>

<p>The unexpected expansion of the heap can be problematic. Unity’s garbage collection strategy tends to fragment memory more often. You should be aware of the following:</p>

<ul>
<li>Unity doesn’t release the memory allocated to the managed heap when it expands regularly; instead, it retains the expanded heap, even if a large section of it is empty. This is to prevent the need to re-expand the heap if further large allocations occur.</li>
<li>On most platforms, Unity eventually releases the memory that the empty portions of the managed heap uses back to the operating system. The interval at which this happens isn’t guaranteed and is unreliable.</li>
</ul>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="performance-memory-overview.html"></a></span><div class="tip">Memory in Unity</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="memory-allocator-customization.html"></a></span><div class="tip">Memory allocator customization</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2022 Unity Technologies. Publication 2021.3</div>
<div class="menu">
<a href="https://learn.unity.com/">教程</a><a href="https://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="https://forum.unity3d.com">论坛</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
