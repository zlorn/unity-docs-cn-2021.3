<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="NativeContainer - Unity 手册">
<title>NativeContainer - Unity 手册</title>
<meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg">
<meta name="description" content="安全系统复制数据的过程的缺点是会将作业的结果隔离到每个副本中。为了克服此限制，需要将结果存储在一种名为 NativeContainer 的共享内存中。">
<meta property="og:description" content="安全系统复制数据的过程的缺点是会将作业的结果隔离到每个副本中。为了克服此限制，需要将结果存储在一种名为 NativeContainer 的共享内存中。">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836"></script><script type="text/javascript">
        function OptanonWrapper() { }
    </script><script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'JobSystemNativeContainer';
      if(!page) page = 'index';
      var version = '2021.3';
      var docs_versions = [{version: '2022.1',version_string: '2022.1',supported: true},{version: '2021.3',version_string: '2021.3',supported: true},{version: '2021.2',version_string: '2021.2',supported: false},{version: '2021.1',version_string: '2021.1',supported: false},{version: '2020.3',version_string: '2020.3',supported: true},{version: '2020.2',version_string: '2020.2',supported: false},{version: '2020.1',version_string: '2020.1',supported: false},{version: '2019.4',version_string: '2019.4',supported: true},{version: '2019.3',version_string: '2019.3',supported: false},{version: '2019.2',version_string: '2019.2',supported: false},{version: '2019.1',version_string: '2019.1',supported: false},{version: '2018.4',version_string: '2018.4',supported: false},{version: '2018.3',version_string: '2018.3',supported: false},{version: '2018.2',version_string: '2018.2',supported: false},{version: '2018.1',version_string: '2018.1',supported: false},{version: '2017.4',version_string: '2017.4',supported: false},{version: '2017.3',version_string: '2017.3',supported: false},{version: '2017.2',version_string: '2017.2',supported: false},{version: '2017.1',version_string: '2017.1',supported: false},{version: '5.6',version_string: '560',supported: false},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/2021.3/Manual/JobSystemNativeContainer.html">
<link rel="alternate" href="https://docs.unity3d.com/en/2021.3/Manual/JobSystemNativeContainer.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/cn/2021.3/Manual/JobSystemNativeContainer.html" hreflang="zh">
<link rel="alternate" href="https://docs.unity3d.com/ja/2021.3/Manual/JobSystemNativeContainer.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/2021.3/Manual/JobSystemNativeContainer.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/2021.3/Manual/JobSystemNativeContainer.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/2021.3/Manual/JobSystemNativeContainer.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/2021.3/Documentation/Manual/JobSystemNativeContainer.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="./index.html"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/JobSystemNativeContainer.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/JobSystemNativeContainer.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/JobSystemNativeContainer.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/JobSystemNativeContainer.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/JobSystemNativeContainer.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/JobSystemNativeContainer.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/JobSystemNativeContainer.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/JobSystemNativeContainer.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/JobSystemNativeContainer.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/JobSystemNativeContainer.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/JobSystemNativeContainer.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/JobSystemNativeContainer.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/JobSystemNativeContainer.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/JobSystemNativeContainer.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/JobSystemNativeContainer.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/JobSystemNativeContainer.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/JobSystemNativeContainer.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/JobSystemNativeContainer.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/JobSystemNativeContainer.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/JobSystemNativeContainer.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2021.3/Documentation/Manual/JobSystemNativeContainer.html">English</a></li>
<li><a data-lang="cn" href="/cn/2021.3/Manual/JobSystemNativeContainer.html">中文</a></li>
<li><a data-lang="ja" href="/ja/2021.3/Manual/JobSystemNativeContainer.html">日本語</a></li>
<li><a data-lang="es" href="/es/2021.3/Manual/JobSystemNativeContainer.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2021.3/Manual/JobSystemNativeContainer.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/2021.3/Manual/JobSystemNativeContainer.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/JobSystemNativeContainer.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/JobSystemNativeContainer.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/JobSystemNativeContainer.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/JobSystemNativeContainer.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/JobSystemNativeContainer.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/JobSystemNativeContainer.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/JobSystemNativeContainer.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/JobSystemNativeContainer.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/JobSystemNativeContainer.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/JobSystemNativeContainer.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/JobSystemNativeContainer.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/JobSystemNativeContainer.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/JobSystemNativeContainer.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/JobSystemNativeContainer.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/JobSystemNativeContainer.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/JobSystemNativeContainer.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/JobSystemNativeContainer.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/JobSystemNativeContainer.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/JobSystemNativeContainer.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/JobSystemNativeContainer.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual 2021.3 (LTS)</a></li>
<li><a href="ScriptingSection.html">脚本</a></li>
<li><a href="JobSystem.html">C# 作业系统</a></li>
<li>NativeContainer</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="JobSystemSafetySystem.html"></a></span><div class="tip">C# 作业系统中的安全系统</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="JobSystemCreatingJobs.html"></a></span><div class="tip">创建作业</div>
</div>
</div></div>
<h1>NativeContainer</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p><a href="JobSystemSafetySystem.html">安全系统</a>复制数据的过程的缺点是会将作业的结果隔离到每个副本中。为了克服此限制，需要将结果存储在一种名为 <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.NativeContainerAttribute.html">NativeContainer</a> 的共享内存中。</p>

<p>A <code>NativeContainer</code> is a managed value type that provides a safe C# wrapper for native memory. It contains a pointer to an unmanaged allocation. When used with the Unity C# Job System, a <code>NativeContainer</code> allows a job to access data shared with the main thread rather than working with a copy. </p>

<h2>Types of NativeContainer</h2>

<p>Unity 附带了一个名为 <a href="../ScriptReference/Unity.Collections.NativeArray_1.html">NativeArray</a> 的 <code>NativeContainer</code>。您也可以使用 <a href="../ScriptReference/Unity.Collections.NativeSlice_1.html">NativeSlice</a> 操作 <code>NativeArray</code>，从特定位置获取特定长度的 <code>NativeArray</code> 子集。</p>

<p><strong>Note</strong>: The <a href="https://docs.unity3d.com/Packages/com.unity.entities@latest">Entity Component System</a> (ECS) package extends the <code>Unity.Collections</code> namespace to include other types of <code>NativeContainer</code>:</p>

<ul>
<li>
<code>NativeList</code> - 可调整大小的 <code>NativeArray</code>。</li>
<li>
<code>NativeHashMap</code> - 键/值对。</li>
<li>
<code>NativeMultiHashMap</code> - 每个键有多个值。</li>
<li>
<code>NativeQueue</code> - 先进先出 (<a href="https://en.wikipedia.org/wiki/FIFO_(computing_and_electronics)">FIFO</a>) 队列。</li>
</ul>

<h2>NativeContainer 和安全系统</h2>

<p>安全系统内置于所有 <code>NativeContainer</code> 类型中。此系统会跟踪在 <code>NativeContainer</code> 中读写的内容。</p>

<p><strong>Note</strong>: All safety checks on <code>NativeContainer</code> types (such as out of bounds checks, deallocation checks, and race condition checks) are only available in the Unity <strong>Editor</strong> and <strong>Play mode</strong>. </p>

<p>Part of this safety system is the <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.DisposeSentinel.html">DisposeSentinel</a> and <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.AtomicSafetyHandle.html">AtomicSafetyHandle</a>. The <code>DisposeSentinel</code> detects memory leaks and gives you an error if you haven’t freed your memory correctly. Triggering the memory leak error happens long after the leak occurred.</p>

<p>使用 <code>AtomicSafetyHandle</code> 可以在代码中转移 <code>NativeContainer</code> 的所有权。例如，如果两个调度的作业正在写入相同的 <code>NativeArray</code>，则安全系统会抛出一个异常，并显示一条明确的错误消息，说明问题的原因和解决方法。调度违规的作业时，安全系统会抛出此异常。</p>

<p>在这种情况下，可以调度具有依赖关系的作业。第一个作业可以写入 <code>NativeContainer</code>，一旦该作业完成执行，下一个作业就可以安全地读取和写入相同的 <code>NativeContainer</code>。从主线程访问数据时，读写限制也适用。安全系统允许多个作业并行读取相同的数据。</p>

<p>By default, when a job has access to a <code>NativeContainer</code>, it has both read and write access. This configuration can slow performance. The C# Job System doesn’t allow you to schedule a job that has write access to a <code>NativeContainer</code> at the same time as another job that’s writing to it.</p>

<p>If a job doesn’t need to write to a <code>NativeContainer</code>, mark the <code>NativeContainer</code> with the <code>[ReadOnly]</code> attribute, like so:</p>

<pre><code class="lang-csharp">[ReadOnly]
public NativeArray&lt;int&gt; input;
</code></pre>

<p>在上面的示例中，允许多个作业同时对 <code>NativeArray</code> 进行只读访问。</p>

<p><strong>注意</strong>：无法防止从作业中访问静态数据。访问静态数据时会绕过所有安全系统，并可能导致 Unity 崩溃。如需了解更多信息，请参阅 <a href="JobSystemTroubleshooting.html">C# 作业系统提示和故障排除</a>。</p>

<h2>NativeContainer Allocator</h2>

<p>When creating a <code>NativeContainer</code>, you must specify the memory allocation type that you need. The allocation type depends on the length of time the job runs. This way you can tailor the allocation to get the best performance possible in each situation. </p>

<p>There are three <a href="../ScriptReference/Unity.Collections.Allocator.html">Allocator</a> types for <code>NativeContainer</code> memory allocation and release. You must specify the appropriate one when instantiating a <code>NativeContainer</code>.</p>

<ul>
<li>
<strong>Allocator.Temp</strong> has the fastest allocation. Use it for allocations with a lifespan of one frame or fewer. However, you can’t use <code>Temp</code> to pass <code>NativeContainer</code> allocations to jobs.</li>
<li>
<strong>Allocator.TempJob</strong> is a slower allocation than <code>Temp</code> but is faster than <code>Persistent</code>. Use it for thread-safe allocations within a lifespan of four frames. <strong>Important:</strong> You must <code>Dispose</code> of this type of allocation within four frames, or the console prints a warning, generated from the native code. Most small jobs use this <code>NativeContainer</code> allocation type.</li>
<li>
<strong>Allocator.Persistent</strong> is the slowest allocation but can last as long as you need it to, and if necessary, throughout the application’s lifetime. It is a wrapper for a direct call to <a href="http://www.cplusplus.com/reference/cstdlib/malloc/">malloc</a>. Longer jobs can use this <code>NativeContainer</code> allocation type. Don’t use <code>Persistent</code> where performance is essential.</li>
</ul>

<p>例如：</p>

<pre><code class="lang-csharp">NativeArray&lt;float&gt; result = new NativeArray&lt;float&gt;(1, Allocator.TempJob);
</code></pre>

<p><strong>Note</strong>: The number 1 in the example above indicates the size of the <code>NativeArray</code>. In this case, it has only one array element because it only stores one piece of data in <code>result</code>.</p>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="JobSystemSafetySystem.html"></a></span><div class="tip">C# 作业系统中的安全系统</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="JobSystemCreatingJobs.html"></a></span><div class="tip">创建作业</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2022 Unity Technologies. Publication 2021.3</div>
<div class="menu">
<a href="https://learn.unity.com/">教程</a><a href="https://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="https://forum.unity3d.com">论坛</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
