<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="字符串和文本 - Unity 手册">
<title>字符串和文本 - Unity 手册</title>
<meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg">
<meta name="description" content="字符串和文本的处理不当是 Unity 项目中性能问题的常见原因。在 C# 中，所有字符串均不可变。对字符串的任何操作均会导致分配一个完整的新字符串。这种操作的代价相对比较高，而且在大型字符串上、大型数据集上或紧凑循环中执行时，接连不断的重复的字符串可能发展成性能问题。">
<meta property="og:description" content="字符串和文本的处理不当是 Unity 项目中性能问题的常见原因。在 C# 中，所有字符串均不可变。对字符串的任何操作均会导致分配一个完整的新字符串。这种操作的代价相对比较高，而且在大型字符串上、大型数据集上或紧凑循环中执行时，接连不断的重复的字符串可能发展成性能问题。">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836"></script><script type="text/javascript">
        function OptanonWrapper() { }
    </script><script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'BestPracticeUnderstandingPerformanceInUnity5';
      if(!page) page = 'index';
      var version = '2021.3';
      var docs_versions = [{version: '2022.1',version_string: '2022.1',supported: true},{version: '2021.3',version_string: '2021.3',supported: true},{version: '2021.2',version_string: '2021.2',supported: false},{version: '2021.1',version_string: '2021.1',supported: false},{version: '2020.3',version_string: '2020.3',supported: true},{version: '2020.2',version_string: '2020.2',supported: false},{version: '2020.1',version_string: '2020.1',supported: false},{version: '2019.4',version_string: '2019.4',supported: true},{version: '2019.3',version_string: '2019.3',supported: false},{version: '2019.2',version_string: '2019.2',supported: false},{version: '2019.1',version_string: '2019.1',supported: false},{version: '2018.4',version_string: '2018.4',supported: false},{version: '2018.3',version_string: '2018.3',supported: false},{version: '2018.2',version_string: '2018.2',supported: false},{version: '2018.1',version_string: '2018.1',supported: false},{version: '2017.4',version_string: '2017.4',supported: false},{version: '2017.3',version_string: '2017.3',supported: false},{version: '2017.2',version_string: '2017.2',supported: false},{version: '2017.1',version_string: '2017.1',supported: false},{version: '5.6',version_string: '560',supported: false},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">
<link rel="alternate" href="https://docs.unity3d.com/en/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/cn/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="zh">
<link rel="alternate" href="https://docs.unity3d.com/ja/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/es/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="es">
<link rel="alternate" href="https://docs.unity3d.com/kr/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/ru/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="ru">
<link rel="alternate" href="https://docs.unity3d.com/2021.3/Documentation/Manual/BestPracticeUnderstandingPerformanceInUnity5.html" hreflang="x-default">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="./index.html"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2021.3/Documentation/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">English</a></li>
<li><a data-lang="cn" href="/cn/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">中文</a></li>
<li><a data-lang="ja" href="/ja/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">日本語</a></li>
<li><a data-lang="es" href="/es/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">한국어</a></li>
<li><a data-lang="ru" href="/ru/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2021.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2021.1</a></li>
<li class="supported"><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2020.1</a></li>
<li class="supported"><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/BestPracticeUnderstandingPerformanceInUnity5.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual 2021.3 (LTS)</a></li>
<li><a href="UnityOverview.html">在 Unity 中操作</a></li>
<li><a href="analysis.html">分析</a></li>
<li><a href="BestPracticeUnderstandingPerformanceInUnity.html">了解 Unity 中的优化</a></li>
<li>字符串和文本</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="BestPracticeUnderstandingPerformanceInUnity4.html"></a></span><div class="tip">资源审核</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="BestPracticeUnderstandingPerformanceInUnity6.html"></a></span><div class="tip">Resources 文件夹</div>
</div>
</div></div>
<h1>字符串和文本</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>字符串和文本的处理不当是 Unity 项目中性能问题的常见原因。在 C# 中，所有字符串均不可变。对字符串的任何操作均会导致分配一个完整的新字符串。这种操作的代价相对比较高，而且在大型字符串上、大型数据集上或紧凑循环中执行时，接连不断的重复的字符串可能发展成性能问题。</p>

<p>此外，由于 N 个字符串连接需要分配 N–1 个中间字符串，串行连接也可能成为托管内存压力的主要原因。</p>

<p>如果必须在紧凑循环中或每帧期间对字符串进行连接，请使用 StringBuilder 执行实际连接操作。为最大限度减少不必要的内存分配，可重复使用 StringBuilder 实例。</p>

<p>Microsoft 整理了一份处理 C# 中的字符串的最佳做法清单，可在这里的 MSDN 网站上找到该清单：<a href="https://msdn.microsoft.com/en-us/library/dd465121(v=vs.110).aspx">msdn.microsoft.com</a>。</p>

<h2>区域约束与序数比对</h2>

<p>在与字符串相关的代码中经常出现的核心性能问题之一是无意间使用了缓慢的默认字符串 API。这些 API 是为商业应用程序构建的，可根据与文本字符有关的多种不同区域性和语言规则来处理字符串。</p>

<p>For example, the following example code returns true when run under the US-English locale, but returns false for many European locales.</p>

<p><strong>Note</strong>:
As of Unity 5.3 and 5.4, Unity’s scripting runtimes always run under the US English (en-US) locale:</p>

<pre><code>    String.Equals("encyclopedia", "encyclopædia");
</code></pre>

<p>For most Unity projects, this is entirely unnecessary. It’s roughly ten times faster to use the ordinal comparison type, which compares strings in a manner familiar to C and C++ programmers: by simply comparing each sequential byte of the string, without regard for the character represented by that byte.</p>

<p>切换至序数比对的方式非常简单，只需将 <code>StringComparison.Ordinal</code> 作为最终参数提供给 <code>String.Equals</code>：</p>

<pre><code>myString.Equals(otherString, StringComparison.Ordinal);

</code></pre>

<h2>低效的内置字符串 API</h2>

<p>Beyond switching to ordinal comparisons, certain C# <code>String</code> APIs are known to be extremely inefficient. Among these are <code>String.Format</code>, <code>String.StartsWith</code> and <code>String.EndsWith</code>. <code>String.Format</code> is difficult to replace, but the inefficient string comparison methods are trivially optimized away.</p>

<p>While Microsoft’s recommendation is to pass <code>StringComparison.Ordinal</code> into any string comparison that doesn’t need to be adjusted for localization, Unity benchmarks show that the impact of this is relatively minimal compared to a custom implementation.</p>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;">方法</th>
	<th style="text-align:left;">100k 短字符串的时间（毫秒）</th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;">
<code>String.StartsWith</code>，默认区域性</td>
	<td style="text-align:left;">137</td>
</tr>
<tr>
	<td style="text-align:left;">
<code>String.EndsWith</code>, default culture</td>
	<td style="text-align:left;">542</td>
</tr>
<tr>
	<td style="text-align:left;">
<code>String.StartsWith</code>，序数</td>
	<td style="text-align:left;">115</td>
</tr>
<tr>
	<td style="text-align:left;">
<code>String.EndsWith</code>，序数</td>
	<td style="text-align:left;">34</td>
</tr>
<tr>
	<td style="text-align:left;">自定义 <code>StartsWith</code> 替换</td>
	<td style="text-align:left;">4.5</td>
</tr>
<tr>
	<td style="text-align:left;">自定义 <code>EndsWith</code> 替换</td>
	<td style="text-align:left;">4.5</td>
</tr>
</tbody>
</table>

<p><code>String.StartsWith</code> 和 <code>String.EndsWith</code> 均可以替换为类似于以下示例的简单的手工编码版本。</p>

<pre><code>
    public static bool CustomEndsWith(this string a, string b)
        {
        int ap = a.Length - 1;
        int bp = b.Length - 1;
    
        while (ap &gt;= 0 &amp;&amp; bp &gt;= 0 &amp;&amp; a [ap] == b [bp])
        {
            ap--;
            bp--;
        }
    
        return (bp &lt; 0);
        }

        public static bool CustomStartsWith(this string a, string b)
        {
        int aLen = a.Length;
        int bLen = b.Length;
    
        int ap = 0; int bp = 0;
    
        while (ap &lt; aLen &amp;&amp; bp &lt; bLen &amp;&amp; a [ap] == b [bp])
        {
            ap++;
            bp++;
        }
    
        return (bp == bLen);
        }

</code></pre>

<h2>正则表达式</h2>

<p>While Regular Expressions are a powerful way to match and manipulate strings, they can be extremely performance-intensive. Further, due to the C# library’s implementation of Regular Expressions, even simple Boolean <code>IsMatch</code> queries allocate large transient datastructures “under the hood.” This transient managed memory churn should be deemed unacceptable, except during initialization.</p>

<p>If regular expressions are necessary, it’s strongly recommended to not use the static <code>Regex.Match</code> or <code>Regex.Replace</code> methods, which accept the regular expression as a string parameter. These methods compile the regular expression on-the-fly and don’t cache the generated object.</p>

<p>以下示例代码为无害的单行代码。</p>

<pre><code>
Regex.Match(myString, "foo");

</code></pre>

<p>但是，该代码每次执行时会产生 5 KB 的垃圾。通过简单的重构即可消除其中的大部分垃圾：</p>

<pre><code>
var myRegExp = new Regex("foo");

myRegExp.Match(myString);

</code></pre>

<p>In this example, each call to <code>myRegExp.Match</code> “only” results in 320 bytes of garbage. While this is still expensive for a simple matching operation, it’s a considerable improvement over the previous example.</p>

<p>Therefore, if the regular expressions are invariant string literals, it’s considerably more efficient to precompile them by passing them as the first parameter of the Regex object’s constructor. These precompiled Regexes should then be reused.</p>

<h2>XML、JSON 和其他长格式文本解析</h2>

<p>Parsing text is often one of the heaviest operations that occurs at loading time. Sometimes, the time spent parsing text can outweigh the time spent loading and instantiating Assets.</p>

<p>The reasons behind this depend on the specific parser used. C#’s built-in XML parser is extremely flexible, but as a result, it’s not optimizable for specific data layouts.</p>

<p>Many third-party parsers are built on reflection. While reflection is an excellent choice during development (because it allows the parser to rapidly adapt to changing data layouts), it’s notoriously slow.</p>

<p>Unity has introduced a partial solution with its built-in <a href="../ScriptReference/JsonUtility.html">JSONUtility</a> API, which provides an interface to Unity’s serialization system that reads/emits JSON. In most benchmarks, it’s faster than pure C# JSON parsers, but it has the same limitations as other interfaces to Unity’s serialization system – it can’t serialized many complex data types, such as Dictionaries, without additional code.</p>

<p><strong>Note</strong>: See the <a href="../ScriptReference/ISerializationCallbackReceiver.html">ISerializationCallbackReceiver</a> interface for one way to add the additional processing necessary to convert to/from complex data types during Unity’s serialization process.</p>

<p>当遇到文本数据解析所引起的性能问题时，请考虑三种替代解决方案。</p>

<h3>方案 1：在构建时解析</h3>

<p>避免文本解析成本的最佳方法是完全取消运行时文本解析。通常，这意味着通过某种构建步骤将文本数据“烘焙”成二进制格式。</p>

<p>大多数选择使用该方法的开发者会将其数据移动到某种 ScriptableObject 衍生的类层级视图中，然后通过 AssetBundle 分配数据。有关使用 ScriptableObjects 的精彩讨论，请参阅 youtube 上 <a href="https://www.youtube.com/watch?v=VBA1QCoEAX4">Richard Fine 的 Unite 2016 讲座</a>。</p>

<p>This strategy offers the best possible performance, but is only suitable for data that doesn’t need to be generated dynamically. it’s best suited for game design parameters and other content.</p>

<h3>方案 2：拆分和延迟加载</h3>

<p>第二种可行的方法是将必须解析的数据拆分为较小的数据块。拆分后，解析数据的成本可分摊到多个帧。在理想的情况下，可识别出为用户提供所需体验而需要的特定数据部分，然后只加载这些部分。</p>

<p>举一个简单的例子：如果项目为平台游戏，则没必要将所有关卡的数据一起序列。如果将数据拆分为每个关卡的独立资源，并且将关卡划分到区域中，则可以在玩家闯关到相应位置时再解析数据。</p>

<p>虽然这听起来不难，但实际上需要在工具编码方面投入大量精力，并可能需要重组数据结构。</p>

<h3>方案 3：线程</h3>

<p>For data that’s parsed entirely into plain C# objects, and doesn’t require any interaction with Unity APIs, it’s possible to move the parsing operations to worker threads.</p>

<p>This option can be extremely powerful on platforms with a significant number of cores. However, it requires careful programming to avoid creating deadlocks and race conditions.</p>

<p><strong>Note</strong>: iOS devices have at most 2 cores. Most Android devices have from 2 to 4. This technique of more interest when building for standalone and console build targets.</p>

<p>Projects that choose to implement threading use the built-in C# <a href="https://msdn.microsoft.com/en-us/library/system.threading.thread(v=vs.110).aspx">Thread</a> and <a href="https://msdn.microsoft.com/en-us/library/system.threading.threadpool(v=vs.110).aspx">ThreadPool</a> classes (see <a href="https://msdn.microsoft.com/en-us/library/system.threading.thread(v=vs.110).aspx">msdn.microsoft.com</a>) to manage their worker threads, along with the standard C# synchronization classes.</p>
<!-- area:core -->
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="BestPracticeUnderstandingPerformanceInUnity4.html"></a></span><div class="tip">资源审核</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="BestPracticeUnderstandingPerformanceInUnity6.html"></a></span><div class="tip">Resources 文件夹</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2022 Unity Technologies. Publication 2021.3</div>
<div class="menu">
<a href="https://learn.unity.com/">教程</a><a href="https://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="https://forum.unity3d.com">论坛</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
